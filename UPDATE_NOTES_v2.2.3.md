# 系統更新說明 v2.2.3

## 📋 本次更新內容 (2026-01-26)

### ✅ 問題修正

#### 1. 溫濕度測點名稱格式修正
**問題**：Temperature_Humidity 工作表中記錄的測點名稱包含括號和單位
- 例如：`秤料室濕度 (%RH)` ❌

**修正**：自動移除括號和單位
- 現在記錄為：`秤料室濕度` ✅

**修改位置**：
```javascript
// InspectionForm.html - 新增輔助函數
function removeUnitFromName(name) {
  return name.replace(/\s*\([^)]*\)\s*$/, '').trim();
}

// 提交時自動處理
const itemName = (item.type === 'temperature' || item.type === 'humidity') 
  ? removeUnitFromName(item.name_zh)  // 移除 (%RH) 或 (℃)
  : item.name_zh;
```

**範例對照**：

| 項目名稱（顯示） | 儲存至 Temperature_Humidity |
|----------------|---------------------------|
| 秤料室濕度 (%RH) | 秤料室濕度 ✅ |
| 物料室濕度 (%RH) | 物料室濕度 ✅ |
| 半成品暫存區溫度 (℃) | 半成品暫存區溫度 ✅ |
| 半成品冷凍區溫度 (℃) | 半成品冷凍區溫度 ✅ |
| 原料庫溫度 (℃) | 原料庫溫度 ✅ |
| 成品庫溫度 (℃) | 成品庫溫度 ✅ |

#### 2. 選單「匯出資料」功能修正
**問題**：點擊選單中的「📤 匯出資料」出現錯誤
```
找不到以下指令函式：exportData
```

**修正**：新增完整的匯出功能

**功能說明**：
```
點擊「📤 匯出資料」
    ↓
選擇匯出類型
    ├─→ [是] 匯出點檢記錄
    │   - 建立新試算表
    │   - 複製 Inspection_Records 所有資料
    │   - 自動格式化
    │   - 開啟新檔案
    │
    ├─→ [否] 匯出溫濕度記錄
    │   - 建立新試算表
    │   - 複製 Temperature_Humidity 所有資料
    │   - 自動格式化
    │   - 開啟新檔案
    │
    └─→ [取消] 取消操作
```

**檔案命名格式**：
- 點檢記錄：`點檢記錄匯出_20260126_153045`
- 溫濕度記錄：`溫濕度記錄匯出_20260126_153045`

#### 3. 新增「系統設定」選單功能
**功能**：快速開啟 System_Config 工作表
```
點擊「⚙️ 系統設定」
    ↓
自動切換到 System_Config 工作表
    ↓
顯示提示訊息（常用設定項目）
```

**可設定項目**：
- 預設點檢人員（逗號分隔）
- 點檢時段
- ISO表單編號
- 數據保留期限
- 預設語系

### 🔧 修改的檔案

#### 1. InspectionForm.html
```javascript
// 新增函數
function removeUnitFromName(name) {
  return name.replace(/\s*\([^)]*\)\s*$/, '').trim();
}

// submitAllInspection() 修改
const itemName = (item.type === 'temperature' || item.type === 'humidity') 
  ? removeUnitFromName(item.name_zh) 
  : item.name_zh;
```

#### 2. Code.gs
```javascript
// 新增三個函數
function openSettings() { ... }     // 開啟系統設定
function exportData() { ... }       // 匯出資料
```

### 📊 測點名稱清理邏輯

**正則表達式**：`/\s*\([^)]*\)\s*$/`
- `\s*` - 匹配括號前的空白
- `\([^)]*\)` - 匹配括號及其內容
- `\s*$` - 匹配括號後的空白到字串結尾

**處理範例**：
```javascript
"秤料室濕度 (%RH)"      → "秤料室濕度"
"半成品暫存區溫度 (℃)"  → "半成品暫存區溫度"
"物料室濕度  (%RH)  "   → "物料室濕度"  // 也會移除多餘空白
```

### 🎯 使用說明

#### 匯出資料
1. 點擊選單：**🏭 點檢系統 > 📤 匯出資料**
2. 選擇要匯出的資料類型：
   - **是** - 匯出點檢記錄（Inspection_Records）
   - **否** - 匯出溫濕度記錄（Temperature_Humidity）
3. 系統會：
   - 建立新的試算表
   - 複製所有資料
   - 自動格式化（標題列藍底白字）
   - 自動調整欄寬
   - 開啟新檔案

#### 檢視溫濕度資料格式
1. 填寫溫濕度項目（例如：秤料室濕度 45）
2. 提交資料
3. 開啟 **Temperature_Humidity** 工作表
4. 確認「測點名稱」欄位顯示：
   - ✅ 正確：`秤料室濕度`
   - ❌ 錯誤：`秤料室濕度 (%RH)`

### ✅ 升級步驟

如果已部署舊版本：

1. **更新程式碼**
   - 開啟 Apps Script 編輯器
   - 更新 `InspectionForm.html`（新增 removeUnitFromName 函數）
   - 更新 `Code.gs`（新增 openSettings 和 exportData 函數）
   - 點擊「💾 儲存」

2. **測試功能**
   - 測試溫濕度項目提交
   - 檢查 Temperature_Humidity 工作表中的測點名稱格式
   - 測試匯出功能（選單 > 📤 匯出資料）
   - 測試系統設定功能（選單 > ⚙️ 系統設定）

### ⚠️ 注意事項

#### 舊資料不受影響
- 已存在的溫濕度記錄不會自動更新
- 新記錄會使用正確格式
- 如需統一格式，可使用試算表的「尋找與取代」功能：
  ```
  尋找：\s*\([^)]*\)
  取代：（空白）
  選項：勾選「使用規則運算式」
  ```

#### TempHumidity_Criteria 設定
確保標準設定工作表中的測點名稱也**不含括號和單位**：
```
正確格式：
- 秤料室濕度
- 物料室濕度
- 半成品暫存區溫度
- 半成品冷凍區溫度
- 原料庫溫度
- 成品庫溫度

錯誤格式：
- 秤料室濕度 (%RH)  ❌
- 半成品暫存區溫度 (℃)  ❌
```

如果標準設定中包含單位，驗證將失敗（找不到匹配的標準值）。

### 📞 問題排查

#### 問題1：溫濕度仍顯示單位
**檢查**：
- 確認已更新 InspectionForm.html
- 重新開啟點檢表單
- 清除瀏覽器快取

#### 問題2：匯出功能無法使用
**檢查**：
- 確認已更新 Code.gs
- 重新整理試算表
- 檢查是否有資料可匯出

#### 問題3：溫濕度驗證失敗
**可能原因**：TempHumidity_Criteria 中的測點名稱格式不一致
**解決方法**：
1. 開啟 TempHumidity_Criteria 工作表
2. 確認測點名稱不含括號和單位
3. 與 Temperature_Humidity 中的名稱完全一致

---

**更新版本**：v2.2.3  
**更新日期**：2026-01-26  
**更新內容**：測點名稱格式修正 + 選單功能補充  
**更新者**：Claude AI
