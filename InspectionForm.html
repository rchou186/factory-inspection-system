<!DOCTYPE html>
<html>
<!--
============================================================================
å·¥å» ç’°å¢ƒè¡›ç”Ÿé»æª¢ç®¡ç†ç³»çµ± - é»æª¢è¼¸å…¥è¡¨å–®
Factory Environmental Hygiene Inspection System - Inspection Form
============================================================================

@file        InspectionForm.html
@version     v2.2.5
@date        2026-01-26
@author      System Developer
@description é»æª¢è³‡æ–™è¼¸å…¥è¡¨å–®ï¼Œæ”¯æ´è·¨å€åŸŸæ‰¹æ¬¡æäº¤ã€æº«æ¿•åº¦è¨˜éŒ„ã€
             å€åŸŸå®Œæˆåº¦è¦–è¦ºæ¨™ç¤ºã€ä¸­è‹±é›™èªåˆ‡æ›

@features
  - 11 å€‹å€åŸŸï¼Œ105 å€‹é»æª¢é …ç›®
  - 6 å€‹æº«æ¿•åº¦è¨˜éŒ„é»
  - ä¸‰ç¨®ç‹€æ…‹ï¼šOK / NOK / å¾…è¿½è¹¤
  - æ‰¹æ¬¡æäº¤ï¼ˆ2-3 ç§’å®Œæˆï¼‰
  - å€åŸŸå®Œæˆåº¦æ¨™ç¤º
  - éŸ¿æ‡‰å¼è¨­è¨ˆï¼ˆæ‰‹æ©Ÿ/å¹³æ¿/é›»è…¦ï¼‰
  - å‹•æ…‹è¡¨å–®ç·¨è™Ÿï¼ˆå¾ System_Config è®€å–ï¼‰

@dependencies
  - Bootstrap 5.3.0
  - Bootstrap Icons 1.10.0
  - Code.gs (getSystemConfig)
  - InspectionItems.gs (getAllInspectionItems)
  - DataHandler.gs (submitInspectionBatch)

@changelog
  v2.2.5 (2026-01-26) - ISO 22000 æ•´åˆï¼Œå‹•æ…‹è¡¨å–®ç·¨è™Ÿ
  v2.2.4 (2026-01-26) - æ‰¹æ¬¡æäº¤æ•ˆèƒ½å„ªåŒ–
  v2.2.3 (2026-01-26) - UI å„ªåŒ–ï¼ŒSubmit æŒ‰éˆ•ä½ç½®èª¿æ•´

============================================================================
-->
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å·¥å» ç’°å¢ƒè¡›ç”Ÿé»æª¢ç³»çµ±</title>
  
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  
  <style>
    :root {
      --primary-color: #4285F4;
      --success-color: #4CAF50;
      --warning-color: #FFC107;
      --danger-color: #F44336;
      --gray-color: #E0E0E0;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f5f5f5;
      padding: 15px;
      margin: 0;
    }
    
    .system-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      position: relative;
    }
    
    .system-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 5px;
    }
    
    .lang-toggle {
      position: absolute;
      top: 15px;
      right: 20px;
      background: rgba(255,255,255,0.2);
      border: 2px solid white;
      color: white;
      padding: 6px 15px;
      border-radius: 20px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.85rem;
      transition: all 0.3s;
    }
    
    .lang-toggle:hover {
      background: rgba(255,255,255,0.3);
    }
    
    .inspection-card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 15px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .area-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 12px;
      margin-top: 15px;
    }
    
    .area-btn {
      padding: 15px;
      border: 2px solid var(--gray-color);
      border-radius: 8px;
      background: white;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
      font-weight: 500;
      position: relative;
    }
    
    .area-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .area-btn.completed {
      background: var(--success-color);
      color: white;
      border-color: var(--success-color);
    }
    
    .area-btn.in-progress {
      background: var(--warning-color);
      color: white;
      border-color: var(--warning-color);
    }
    
    .area-btn.selected {
      border-color: var(--primary-color);
      border-width: 3px;
      box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.2);
    }
    
    .area-name {
      font-size: 1rem;
      margin-bottom: 5px;
    }
    
    .area-name-en {
      font-size: 0.75rem;
      opacity: 0.8;
      margin-bottom: 5px;
    }
    
    .area-progress {
      font-size: 0.85rem;
      font-weight: 600;
      margin-top: 8px;
      padding: 3px 8px;
      background: rgba(0,0,0,0.1);
      border-radius: 10px;
      display: inline-block;
    }
    
    .area-btn.completed .area-progress,
    .area-btn.in-progress .area-progress {
      background: rgba(255,255,255,0.3);
    }
    
    .item-card {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 15px;
      border-left: 4px solid var(--primary-color);
    }
    
    .item-number {
      display: inline-block;
      background: var(--primary-color);
      color: white;
      width: 30px;
      height: 30px;
      line-height: 30px;
      text-align: center;
      border-radius: 50%;
      font-weight: 600;
      margin-right: 10px;
    }
    
    .item-name {
      font-size: 1.05rem;
      font-weight: 600;
      margin-bottom: 5px;
    }
    
    .item-name-en {
      color: #666;
      font-size: 0.85rem;
      margin-bottom: 15px;
    }
    
    .status-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .status-btn {
      flex: 1;
      padding: 10px;
      border: 2px solid;
      border-radius: 6px;
      background: white;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
      font-size: 0.9rem;
    }
    
    .status-btn.ok {
      border-color: var(--success-color);
      color: var(--success-color);
    }
    
    .status-btn.ok.active {
      background: var(--success-color);
      color: white;
    }
    
    .status-btn.nok {
      border-color: var(--danger-color);
      color: var(--danger-color);
    }
    
    .status-btn.nok.active {
      background: var(--danger-color);
      color: white;
    }
    
    .status-btn.pending {
      border-color: var(--warning-color);
      color: var(--warning-color);
    }
    
    .status-btn.pending.active {
      background: var(--warning-color);
      color: white;
    }
    
    .temp-humidity-input {
      background: #e3f2fd;
      border-left-color: #2196F3;
    }
    
    .temp-status {
      display: inline-block;
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 600;
      margin-top: 10px;
    }
    
    .temp-status.normal {
      background: #c8e6c9;
      color: #2e7d32;
    }
    
    .temp-status.abnormal {
      background: #ffcdd2;
      color: #c62828;
    }
    
    .loading {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      z-index: 1000;
      text-align: center;
    }
    
    .loading.show {
      display: block;
    }
    
    /* è‡ªè¨‚ç¢ºèªå°è©±æ¡† */
    .custom-confirm-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }
    
    .custom-confirm-overlay.show {
      display: flex;
    }
    
    .custom-confirm-box {
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      max-width: 400px;
      width: 90%;
      padding: 0;
      animation: slideDown 0.3s ease;
    }
    
    @keyframes slideDown {
      from {
        transform: translateY(-50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    .custom-confirm-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 12px 12px 0 0;
      font-size: 1.2rem;
      font-weight: 600;
    }
    
    .custom-confirm-body {
      padding: 30px 20px;
      font-size: 1.1rem;
      color: #333;
      line-height: 1.6;
    }
    
    .custom-confirm-footer {
      padding: 15px 20px;
      border-top: 1px solid #eee;
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
    
    .custom-confirm-btn {
      padding: 10px 24px;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .custom-confirm-btn.cancel {
      background: #e0e0e0;
      color: #666;
    }
    
    .custom-confirm-btn.cancel:hover {
      background: #d0d0d0;
    }
    
    .custom-confirm-btn.confirm {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .custom-confirm-btn.confirm:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }
    
    .progress-summary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      text-align: center;
      font-size: 1.2rem;
      font-weight: 600;
    }
    
    @media (max-width: 768px) {
      .area-grid {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      }
      
      .system-title {
        font-size: 1.2rem;
      }
      
      .status-buttons {
        flex-direction: column;
      }
      
      .lang-toggle {
        position: static;
        display: inline-block;
        margin-top: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="container-fluid">
    <!-- ç³»çµ±æ¨™é¡Œ -->
    <div class="system-header position-relative">
      <button class="lang-toggle" onclick="toggleLanguage()">
        <i class="bi bi-globe"></i> 
        <span id="langText">ä¸­æ–‡ / EN</span>
      </button>
      <div class="system-title" id="systemTitle">
        ğŸ­ å·¥å» ç’°å¢ƒè¡›ç”Ÿé»æª¢ç³»çµ±
      </div>
      <div style="font-size: 0.9rem; opacity: 0.9;" id="systemSubtitle">
        Factory Environmental Hygiene Inspection System
      </div>
      <div style="font-size: 0.85rem; margin-top: 8px; opacity: 0.8;">
        <span id="formNumberLabel">è¡¨å–®ç·¨è™Ÿ</span>: <span id="formNumber">è¼‰å…¥ä¸­...</span>
      </div>
    </div>
    
    <!-- åŸºæœ¬è³‡è¨Š -->
    <div class="inspection-card">
      <h6 class="mb-3">
        <i class="bi bi-calendar-check"></i> 
        <span id="basicInfoTitle">åŸºæœ¬è³‡è¨Š</span>
      </h6>
      
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label"><span id="dateLabel">æ—¥æœŸ</span> Date</label>
          <input type="date" class="form-control" id="inspectionDate" required>
        </div>
        
        <div class="col-md-4">
          <label class="form-label"><span id="shiftLabel">æ™‚æ®µ</span> Shift</label>
          <select class="form-select" id="inspectionShift" required>
            <option value="æ—©">æ—© Morning</option>
            <option value="æ™š">æ™š Evening</option>
            <option value="å…¶å®ƒ">å…¶å®ƒ Other</option>
          </select>
        </div>
        
        <div class="col-md-4">
          <label class="form-label"><span id="inspectorLabel">é»æª¢äººå“¡</span> Inspector</label>
          <select class="form-select" id="inspectorName" required>
            <option value="">-- è«‹é¸æ“‡ Please Select --</option>
          </select>
        </div>
      </div>
    </div>
    
    <!-- æ•´é«”é€²åº¦ -->
    <div class="progress-summary" id="totalProgress">
      <i class="bi bi-check2-square"></i> 
      <span id="progressLabel">ç¸½é€²åº¦</span> Total Progress: 
      <span id="totalProgressText">0/0 (0%)</span>
    </div>
    
    <!-- å€åŸŸé¸æ“‡ -->
    <div class="inspection-card">
      <h6 class="mb-3">
        <i class="bi bi-building"></i> 
        <span id="areaSelectionTitle">å€åŸŸé¸æ“‡</span> Area Selection
      </h6>
      <div class="text-muted mb-3" style="font-size: 0.85rem;">
        <span style="color: var(--success-color);">â— <span id="completedLabel">å·²å®Œæˆ</span></span>
        <span style="margin-left: 15px; color: var(--warning-color);">â— <span id="inProgressLabel">é€²è¡Œä¸­</span></span>
        <span style="margin-left: 15px; color: var(--gray-color);">â— <span id="notStartedLabel">æœªé–‹å§‹</span></span>
      </div>
      <div class="area-grid" id="areaGrid">
        <!-- å‹•æ…‹ç”¢ç”Ÿå€åŸŸæŒ‰éˆ• -->
      </div>
      
      <!-- æäº¤æŒ‰éˆ• -->
      <div class="text-center mt-4">
        <button class="btn btn-primary btn-lg" onclick="submitAllInspection()" style="min-width: 250px; padding: 12px 30px; font-size: 1.1rem; font-weight: 600;">
          <i class="bi bi-check-circle"></i> 
          <span id="submitBtnText">æäº¤æ‰€æœ‰é»æª¢è³‡æ–™</span>
        </button>
      </div>
    </div>
    
    <!-- é»æª¢é …ç›® -->
    <div class="inspection-card" id="itemsSection" style="display: none;">
      <h6 class="mb-3">
        <i class="bi bi-list-check"></i> 
        <span id="itemsTitle">é»æª¢é …ç›®</span>
        <span id="areaName" class="text-primary"></span>
      </h6>
      
      <div class="alert alert-info">
        <i class="bi bi-info-circle"></i>
        <span id="areaProgressLabel">æœ¬å€é€²åº¦</span>: 
        <span id="itemProgress">0/0</span>
      </div>
      
      <div id="itemsList">
        <!-- å‹•æ…‹ç”¢ç”Ÿé»æª¢é …ç›® -->
      </div>
    </div>
    
    <!-- è¼‰å…¥ä¸­ -->
    <div class="loading" id="loadingDiv">
      <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
        <span class="visually-hidden">Loading...</span>
      </div>
      <div class="mt-3" id="loadingText">è™•ç†ä¸­ï¼Œè«‹ç¨å€™...</div>
    </div>
    
    <!-- è‡ªè¨‚ç¢ºèªå°è©±æ¡† -->
    <div class="custom-confirm-overlay" id="customConfirmOverlay">
      <div class="custom-confirm-box">
        <div class="custom-confirm-header" id="confirmHeader">
          <i class="bi bi-check-circle"></i> ç¢ºèªæäº¤
        </div>
        <div class="custom-confirm-body" id="confirmMessage">
          ç¢ºå®šè¦æäº¤é»æª¢è³‡æ–™å—ï¼Ÿ
        </div>
        <div class="custom-confirm-footer">
          <button class="custom-confirm-btn cancel" id="confirmCancelBtn">
            <i class="bi bi-x-circle"></i> å–æ¶ˆ
          </button>
          <button class="custom-confirm-btn confirm" id="confirmOkBtn">
            <i class="bi bi-check-circle"></i> ç¢ºå®š
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    let currentLang = 'zh-TW';
    let currentArea = null;
    let inspectionData = {}; // å„²å­˜æ‰€æœ‰å€åŸŸçš„é»æª¢è³‡æ–™
    let allAreas = [];
    
    // ç¿»è­¯å°ç…§è¡¨
    const i18n = {
      'zh-TW': {
        systemTitle: 'ğŸ­ å·¥å» ç’°å¢ƒè¡›ç”Ÿé»æª¢ç³»çµ±',
        systemSubtitle: 'Factory Environmental Hygiene Inspection System',
        formNumberLabel: 'è¡¨å–®ç·¨è™Ÿ',
        basicInfoTitle: 'åŸºæœ¬è³‡è¨Š',
        dateLabel: 'æ—¥æœŸ',
        shiftLabel: 'æ™‚æ®µ',
        inspectorLabel: 'é»æª¢äººå“¡',
        progressLabel: 'ç¸½é€²åº¦',
        areaSelectionTitle: 'å€åŸŸé¸æ“‡',
        completedLabel: 'å·²å®Œæˆ',
        inProgressLabel: 'é€²è¡Œä¸­',
        notStartedLabel: 'æœªé–‹å§‹',
        itemsTitle: 'é»æª¢é …ç›®',
        areaProgressLabel: 'æœ¬å€é€²åº¦',
        submitBtnText: 'æäº¤æ‰€æœ‰é»æª¢è³‡æ–™',
        loadingText: 'è™•ç†ä¸­ï¼Œè«‹ç¨å€™...',
        langText: 'ä¸­æ–‡ / EN',
        okBtn: 'OK',
        nokBtn: 'NOK',
        pendingBtn: 'å¾…è¿½è¹¤',
        notePlaceholder: 'å‚™è¨» (é¸å¡«)',
        tempPlaceholder: 'æº«åº¦ (â„ƒ)',
        humidityPlaceholder: 'æ¿•åº¦ (%RH)'
      },
      'en-US': {
        systemTitle: 'ğŸ­ Factory Environmental Hygiene Inspection System',
        systemSubtitle: 'å·¥å» ç’°å¢ƒè¡›ç”Ÿé»æª¢ç³»çµ±',
        formNumberLabel: 'Form Number',
        basicInfoTitle: 'Basic Information',
        dateLabel: 'Date',
        shiftLabel: 'Shift',
        inspectorLabel: 'Inspector',
        progressLabel: 'Total Progress',
        areaSelectionTitle: 'Area Selection',
        completedLabel: 'Completed',
        inProgressLabel: 'In Progress',
        notStartedLabel: 'Not Started',
        itemsTitle: 'Inspection Items',
        areaProgressLabel: 'Area Progress',
        submitBtnText: 'Submit All',
        loadingText: 'Processing, please wait...',
        langText: 'EN / ä¸­æ–‡',
        okBtn: 'OK',
        nokBtn: 'NOK',
        pendingBtn: 'Pending',
        notePlaceholder: 'Note (Optional)',
        tempPlaceholder: 'Temperature (â„ƒ)',
        humidityPlaceholder: 'Humidity (%RH)'
      }
    };
    
    // åˆå§‹åŒ–
    window.onload = function() {
      document.getElementById('inspectionDate').valueAsDate = new Date();
      loadSystemConfig();
      loadInspectors();
      loadAreas();
    };
    
    // è¼‰å…¥ç³»çµ±è¨­å®šï¼ˆè¡¨å–®ç·¨è™Ÿï¼‰
    function loadSystemConfig() {
      google.script.run
        .withSuccessHandler(function(config) {
          if (config && config.formNumber) {
            document.getElementById('formNumber').textContent = config.formNumber;
          }
        })
        .withFailureHandler(function(error) {
          console.error('è¼‰å…¥ç³»çµ±è¨­å®šå¤±æ•—:', error);
          document.getElementById('formNumber').textContent = 'P-4-001 ç‰ˆæœ¬ A1';
        })
        .getSystemConfig();
    }
    
    // è¼‰å…¥é»æª¢äººå“¡
    function loadInspectors() {
      google.script.run
        .withSuccessHandler(function(inspectors) {
          const select = document.getElementById('inspectorName');
          select.innerHTML = '<option value="">-- è«‹é¸æ“‡ Please Select --</option>';
          inspectors.forEach(inspector => {
            const option = document.createElement('option');
            option.value = inspector;
            option.textContent = inspector;
            select.appendChild(option);
          });
        })
        .withFailureHandler(function(error) {
          console.error('è¼‰å…¥é»æª¢äººå“¡å¤±æ•—:', error);
        })
        .getInspectorList();
    }
    
    // è¼‰å…¥å€åŸŸ
    function loadAreas() {
      google.script.run
        .withSuccessHandler(function(areas) {
          allAreas = areas;
          renderAreas();
          updateTotalProgress();
        })
        .withFailureHandler(function(error) {
          alert('è¼‰å…¥å€åŸŸå¤±æ•—: ' + error);
        })
        .getAllInspectionItems();
    }
    
    // æ¸²æŸ“å€åŸŸæŒ‰éˆ•
    function renderAreas() {
      const grid = document.getElementById('areaGrid');
      grid.innerHTML = '';
      
      allAreas.forEach((area, index) => {
        const areaKey = area.code;
        const completed = getAreaCompletedCount(areaKey);
        const total = area.items.length;
        
        const btn = document.createElement('div');
        btn.className = 'area-btn';
        btn.dataset.areaCode = areaKey;
        
        if (completed === total && total > 0) {
          btn.classList.add('completed');
        } else if (completed > 0) {
          btn.classList.add('in-progress');
        }
        
        btn.innerHTML = `
          <div class="area-name">${area.name_zh}</div>
          <div class="area-name-en">${area.name_en}</div>
          <div class="area-progress">${completed}/${total}</div>
        `;
        btn.onclick = () => selectArea(area, btn);
        grid.appendChild(btn);
      });
    }
    
    // å–å¾—å€åŸŸå®Œæˆæ•¸é‡
    function getAreaCompletedCount(areaCode) {
      if (!inspectionData[areaCode]) return 0;
      return Object.keys(inspectionData[areaCode]).length;
    }
    
    // é¸æ“‡å€åŸŸ
    function selectArea(area, btnElement) {
      currentArea = area;
      
      document.querySelectorAll('.area-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      btnElement.classList.add('selected');
      
      renderItems();
      
      document.getElementById('itemsSection').style.display = 'block';
      document.getElementById('areaName').textContent = `(${area.name_zh})`;
      
      setTimeout(() => {
        document.getElementById('itemsSection').scrollIntoView({behavior: 'smooth', block: 'start'});
      }, 100);
    }
    
    // æ¸²æŸ“é»æª¢é …ç›®
    function renderItems() {
      const list = document.getElementById('itemsList');
      list.innerHTML = '';
      
      const areaKey = currentArea.code;
      const areaData = inspectionData[areaKey] || {};
      const t = i18n[currentLang];
      
      currentArea.items.forEach((item) => {
        const card = document.createElement('div');
        card.className = 'item-card';
        
        const isTempHumidity = item.type === 'temperature' || item.type === 'humidity';
        
        if (isTempHumidity) {
          card.classList.add('temp-humidity-input');
        }
        
        const savedData = areaData[item.no] || {};
        const savedStatus = savedData.status || '';
        const savedNote = savedData.note || '';
        const savedValue = savedData.value || '';
        
        const displayName = currentLang === 'zh-TW' ? item.name_zh : item.name_en;
        const altName = currentLang === 'zh-TW' ? item.name_en : item.name_zh;
        
        card.innerHTML = `
          <div class="item-name">
            <span class="item-number">${item.no}</span>
            ${displayName}
          </div>
          <div class="item-name-en">${altName}</div>
          
          ${isTempHumidity ? `
            <div class="row g-2 mb-3">
              <div class="col-md-6">
                <input type="number" step="0.1" class="form-control" 
                       placeholder="${item.type === 'temperature' ? t.tempPlaceholder : t.humidityPlaceholder}"
                       id="value_${areaKey}_${item.no}"
                       value="${savedValue}"
                       onchange="saveTempHumidity('${areaKey}', ${item.no}, '${item.type}')">
              </div>
            </div>
          ` : `
            <div class="status-buttons">
              <button class="status-btn ok ${savedStatus === 'OK' ? 'active' : ''}" 
                      onclick="selectStatus('${areaKey}', ${item.no}, 'OK', this)">
                <i class="bi bi-check-circle"></i> ${t.okBtn}
              </button>
              <button class="status-btn nok ${savedStatus === 'NOK' ? 'active' : ''}" 
                      onclick="selectStatus('${areaKey}', ${item.no}, 'NOK', this)">
                <i class="bi bi-x-circle"></i> ${t.nokBtn}
              </button>
              <button class="status-btn pending ${savedStatus === 'å¾…è¿½è¹¤' ? 'active' : ''}" 
                      onclick="selectStatus('${areaKey}', ${item.no}, 'å¾…è¿½è¹¤', this)">
                <i class="bi bi-clock"></i> ${t.pendingBtn}
              </button>
            </div>
          `}
          
          <textarea class="form-control" rows="2" 
                    placeholder="${t.notePlaceholder}" 
                    id="note_${areaKey}_${item.no}"
                    onchange="saveNote('${areaKey}', ${item.no})">${savedNote}</textarea>
        `;
        
        list.appendChild(card);
      });
      
      updateAreaProgress();
    }
    
    // é¸æ“‡ç‹€æ…‹
    function selectStatus(areaKey, itemNo, status, btnElement) {
      const buttons = btnElement.parentElement.querySelectorAll('.status-btn');
      buttons.forEach(btn => btn.classList.remove('active'));
      btnElement.classList.add('active');
      
      if (!inspectionData[areaKey]) inspectionData[areaKey] = {};
      if (!inspectionData[areaKey][itemNo]) inspectionData[areaKey][itemNo] = {};
      inspectionData[areaKey][itemNo].status = status;
      
      updateAreaProgress();
      updateTotalProgress();
      renderAreas();
    }
    
    // å„²å­˜å‚™è¨»
    function saveNote(areaKey, itemNo) {
      const note = document.getElementById(`note_${areaKey}_${itemNo}`).value;
      if (!inspectionData[areaKey]) inspectionData[areaKey] = {};
      if (!inspectionData[areaKey][itemNo]) inspectionData[areaKey][itemNo] = {};
      inspectionData[areaKey][itemNo].note = note;
    }
    
    // å„²å­˜æº«æ¿•åº¦
    function saveTempHumidity(areaKey, itemNo, type) {
      const value = document.getElementById(`value_${areaKey}_${itemNo}`).value;
      if (!inspectionData[areaKey]) inspectionData[areaKey] = {};
      if (!inspectionData[areaKey][itemNo]) inspectionData[areaKey][itemNo] = {};
      inspectionData[areaKey][itemNo].value = value;
      inspectionData[areaKey][itemNo].type = type;
      inspectionData[areaKey][itemNo].status = 'TEMP';
      
      updateAreaProgress();
      updateTotalProgress();
      renderAreas();
    }
    
    // æ›´æ–°å€åŸŸé€²åº¦
    function updateAreaProgress() {
      if (!currentArea) return;
      const completed = getAreaCompletedCount(currentArea.code);
      const total = currentArea.items.length;
      document.getElementById('itemProgress').textContent = `${completed}/${total}`;
    }
    
    // æ›´æ–°ç¸½é€²åº¦
    function updateTotalProgress() {
      let totalCompleted = 0, totalItems = 0;
      allAreas.forEach(area => {
        totalItems += area.items.length;
        totalCompleted += getAreaCompletedCount(area.code);
      });
      const percentage = totalItems > 0 ? Math.round((totalCompleted / totalItems) * 100) : 0;
      document.getElementById('totalProgressText').textContent = `${totalCompleted}/${totalItems} (${percentage}%)`;
    }
    
    // åˆ‡æ›èªç³»
    function toggleLanguage() {
      currentLang = currentLang === 'zh-TW' ? 'en-US' : 'zh-TW';
      updateUILanguage();
      if (currentArea) renderItems();
    }
    
    // è‡ªè¨‚ç¢ºèªå°è©±æ¡†
    function customConfirm(message, onConfirm) {
      const overlay = document.getElementById('customConfirmOverlay');
      const messageEl = document.getElementById('confirmMessage');
      const okBtn = document.getElementById('confirmOkBtn');
      const cancelBtn = document.getElementById('confirmCancelBtn');
      const header = document.getElementById('confirmHeader');
      
      // è¨­å®šè¨Šæ¯
      messageEl.textContent = message;
      
      // æ›´æ–°æŒ‰éˆ•æ–‡å­—ï¼ˆæ ¹æ“šèªç³»ï¼‰
      if (currentLang === 'zh-TW') {
        header.innerHTML = '<i class="bi bi-check-circle"></i> ç¢ºèªæäº¤';
        cancelBtn.innerHTML = '<i class="bi bi-x-circle"></i> å–æ¶ˆ';
        okBtn.innerHTML = '<i class="bi bi-check-circle"></i> ç¢ºå®š';
      } else {
        header.innerHTML = '<i class="bi bi-check-circle"></i> Confirm Submission';
        cancelBtn.innerHTML = '<i class="bi bi-x-circle"></i> Cancel';
        okBtn.innerHTML = '<i class="bi bi-check-circle"></i> Confirm';
      }
      
      // é¡¯ç¤ºå°è©±æ¡†
      overlay.classList.add('show');
      
      // ç¢ºå®šæŒ‰éˆ•äº‹ä»¶
      okBtn.onclick = function() {
        overlay.classList.remove('show');
        onConfirm();
      };
      
      // å–æ¶ˆæŒ‰éˆ•äº‹ä»¶
      cancelBtn.onclick = function() {
        overlay.classList.remove('show');
      };
      
      // é»æ“ŠèƒŒæ™¯é—œé–‰
      overlay.onclick = function(e) {
        if (e.target === overlay) {
          overlay.classList.remove('show');
        }
      };
    }
    
    // æ›´æ–°ä»‹é¢èªè¨€
    function updateUILanguage() {
      const t = i18n[currentLang];
      Object.keys(t).forEach(key => {
        const el = document.getElementById(key);
        if (el) el.textContent = t[key];
      });
    }
    
    // ç§»é™¤é …ç›®åç¨±ä¸­çš„å–®ä½ï¼ˆæ‹¬è™Ÿéƒ¨åˆ†ï¼‰
    function removeUnitFromName(name) {
      // ç§»é™¤ (â„ƒ), (%RH) ç­‰æ‹¬è™Ÿå…§å®¹
      return name.replace(/\s*\([^)]*\)\s*$/, '').trim();
    }
    
    // æäº¤æ‰€æœ‰é»æª¢è³‡æ–™
    function submitAllInspection() {
      const date = document.getElementById('inspectionDate').value;
      const shift = document.getElementById('inspectionShift').value;
      const inspector = document.getElementById('inspectorName').value;
      
      if (!date || !shift || !inspector) {
        alert(currentLang === 'zh-TW' ? 'è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½ï¼' : 'Please fill in all required fields!');
        return;
      }
      
      const dataArray = [];
      allAreas.forEach(area => {
        const areaData = inspectionData[area.code];
        if (areaData) {
          area.items.forEach(item => {
            const itemData = areaData[item.no];
            if (itemData && (itemData.status || itemData.value)) {
              // å°æº«æ¿•åº¦é …ç›®ï¼Œç§»é™¤åç¨±ä¸­çš„å–®ä½
              const itemName = (item.type === 'temperature' || item.type === 'humidity') 
                ? removeUnitFromName(item.name_zh) 
                : item.name_zh;
              
              dataArray.push({
                date, shift, inspector,
                area: area.name_zh,
                itemNo: item.no,
                itemName: itemName,
                status: itemData.status,
                value: itemData.value,
                type: itemData.type,
                note: itemData.note || ''
              });
            }
          });
        }
      });
      
      if (dataArray.length === 0) {
        alert(currentLang === 'zh-TW' ? 'è«‹è‡³å°‘å®Œæˆä¸€å€‹é …ç›®çš„é»æª¢ï¼' : 'Please complete at least one item!');
        return;
      }
      
      const msg = currentLang === 'zh-TW' 
        ? `ç¢ºå®šè¦æäº¤ ${dataArray.length} ç­†é»æª¢è³‡æ–™å—ï¼Ÿ` 
        : `Submit ${dataArray.length} records?`;
      
      // ä½¿ç”¨è‡ªè¨‚ç¢ºèªå°è©±æ¡†
      customConfirm(msg, function() {
        document.getElementById('loadingDiv').classList.add('show');
        
        google.script.run
          .withSuccessHandler(function(result) {
            document.getElementById('loadingDiv').classList.remove('show');
            if (result.success) {
              alert(currentLang === 'zh-TW' 
                ? `âœ… æäº¤æˆåŠŸï¼å…± ${result.count} ç­†è¨˜éŒ„` 
                : `âœ… Success! ${result.count} records`);
              inspectionData = {};
              renderAreas();
              updateTotalProgress();
              document.getElementById('itemsSection').style.display = 'none';
            } else {
              alert('âŒ ' + result.error);
            }
          })
          .withFailureHandler(function(error) {
            document.getElementById('loadingDiv').classList.remove('show');
            alert('âŒ ' + error);
          })
          .submitInspectionBatch(dataArray);
      });
    }
  </script>
</body>
</html>
