# 溫濕度告警 Email 通知設定指南

## 📧 如何設定溫濕度告警通知

當溫濕度超標時，系統會自動發送 Email 通知給指定的收件人。以下是完整的設定步驟。

---

## ⚙️ 設定步驟

### 步驟 1：開啟 TempHumidity_Criteria 工作表

1. 開啟您的點檢系統試算表
2. 找到「**TempHumidity_Criteria**」工作表（溫濕度標準設定）
3. 點擊該工作表

### 步驟 2：檢查測點標準設定

確認以下 6 個溫濕度測點都已設定標準值：

| 測點名稱 | 所屬區域 | 測量類型 | 單位 | 下限值 | 上限值 |
|---------|---------|---------|------|--------|--------|
| 秤料室濕度 | B1區 | 濕度 | %RH | 30 | 60 |
| 物料室濕度 | B1區 | 濕度 | %RH | 30 | 60 |
| 半成品暫存區溫度 | 蒸煮區 | 溫度 | ℃ | 0 | 7 |
| 半成品冷凍區溫度 | 蒸煮區 | 溫度 | ℃ | -18 | -10 |
| 原料庫溫度 | 其他 | 溫度 | ℃ | -20 | -15 |
| 成品庫溫度 | 其他 | 溫度 | ℃ | -20 | -15 |

⚠️ **重要**：測點名稱必須**完全一致**（不含括號和單位）

### 步驟 3：啟用告警功能

在「**是否啟用告警**」欄位中：
- 輸入 `TRUE` 或 `是` = 啟用告警
- 輸入 `FALSE` 或 `否` = 不告警

**範例**：
```
秤料室濕度 → 是否啟用告警：TRUE  ✅
物料室濕度 → 是否啟用告警：FALSE ❌ (不會發送告警)
```

### 步驟 4：設定收件人 Email

在「**告警收件人**」欄位中輸入 Email 地址：

#### 單一收件人
```
manager@company.com
```

#### 多個收件人（用逗號分隔）
```
manager@company.com,supervisor@company.com,quality@company.com
```

⚠️ **注意事項**：
- Email 地址之間用**英文逗號**分隔
- 不要有多餘空白（系統會自動清理）
- 確保 Email 格式正確

### 步驟 5：設定告警方式（可選）

在「**告警方式**」欄位中可以輸入：
- `郵件` - 僅發送郵件（目前版本僅支援此項）
- `推播` - 推播通知（未來版本）
- `郵件+推播` - 兩者皆發送（未來版本）

**目前版本預設為「郵件」**

### 步驟 6：儲存設定

完成設定後，直接關閉工作表即可（Google Sheets 自動儲存）

---

## 🎯 完整設定範例

### 範例 1：啟用秤料室濕度告警
```
測點名稱：秤料室濕度
所屬區域：B1區
測量類型：濕度
單位：%RH
下限值：30
上限值：60
是否啟用告警：TRUE
告警方式：郵件
告警收件人：quality@company.com,manager@company.com
備註：每日監控
```

### 範例 2：不啟用物料室濕度告警
```
測點名稱：物料室濕度
所屬區域：B1區
測量類型：濕度
單位：%RH
下限值：30
上限值：60
是否啟用告警：FALSE
告警方式：（留空）
告警收件人：（留空）
備註：暫時不需告警
```

### 範例 3：啟用冷凍庫溫度告警（多個收件人）
```
測點名稱：半成品冷凍區溫度
所屬區域：蒸煮區
測量類型：溫度
單位：℃
下限值：-18
上限值：-10
是否啟用告警：TRUE
告警方式：郵件
告警收件人：manager@company.com,quality@company.com,production@company.com
備註：冷凍庫重要監控點
```

---

## 📬 告警 Email 格式

當溫濕度超標時，收件人會收到以下格式的郵件：

### 郵件主旨
```
⚠️【警告】溫濕度異常告警 - 秤料室濕度
```
或
```
🚨【嚴重】溫濕度異常告警 - 半成品冷凍區溫度
```

### 郵件內容
```
================================================
工廠環境衛生點檢系統 - 溫濕度異常通知
Factory Environmental Hygiene Inspection System
================================================

【告警等級】⚠️ 警告

【測點資訊】
測點名稱：秤料室濕度
所屬區域：B1區
測量時間：2026-01-26 (早班)
測量值：68 %RH
標準範圍：30 ~ 60 %RH

【異常狀態】
偏離值：8.0 %RH

【點檢資訊】
點檢人員：張三
備註說明：空調故障，已報修

【建議處理措施】
1. 立即檢查空調除濕系統
2. 確認門窗密閉狀況
3. 記錄環境溫度
4. 採取必要調整措施

【查看詳細記錄】
請登入系統查看完整記錄和趨勢分析。

================================================
此為系統自動發送，請勿回覆
System Alert - Do Not Reply
================================================
```

---

## 🔔 告警等級說明

系統會根據偏離程度自動判定告警等級：

### 等級 1：警告 ⚠️
- 偏離值 < 標準範圍的 20%
- 例如：標準 30-60，偏離 8 → 警告

### 等級 2：注意 ⚡
- 偏離值 10-20% 標準範圍
- （目前版本暫未區分）

### 等級 3：嚴重 🚨
- 偏離值 > 標準範圍的 20%
- 例如：標準 30-60，偏離 10 以上 → 嚴重

---

## 🛡️ 告警抑制機制

為避免郵件轟炸，系統設有告警抑制機制：

### 規則
- **同一測點 1 小時內只發送 1 次告警**
- 例如：秤料室濕度在 08:30 發送告警後，09:30 之前不會再次發送

### 優點
- 避免重複通知
- 給予處理時間
- 減少郵件騷擾

### 查看抑制狀態
- 告警被抑制時，會記錄在系統日誌中
- 可在 Apps Script 執行記錄查看

---

## ✅ 測試告警功能

### 測試步驟

1. **設定測點標準**（如上述步驟）
   ```
   測點：秤料室濕度
   標準：30-60 %RH
   啟用告警：TRUE
   收件人：your-email@company.com
   ```

2. **填寫超標數值**
   - 開啟點檢表單
   - 填寫 B1區
   - 秤料室濕度輸入：**70**（超過上限60）
   - 備註：測試告警功能
   - 提交

3. **檢查收件**
   - 約 10-30 秒後檢查 Email
   - 應收到告警郵件
   - 檢查垃圾郵件資料夾

4. **查看告警記錄**
   - 開啟「**Alert_History**」工作表（自動建立）
   - 確認告警記錄已寫入

---

## 🔧 故障排除

### 問題 1：沒有收到告警郵件

**檢查清單**：
- [ ] TempHumidity_Criteria 中「是否啟用告警」是否為 TRUE
- [ ] 「告警收件人」欄位是否有填寫 Email
- [ ] Email 格式是否正確
- [ ] 測點名稱是否完全一致（不含括號和單位）
- [ ] 數值是否真的超標
- [ ] 檢查垃圾郵件資料夾
- [ ] 是否在 1 小時內重複發送（告警抑制）

**解決方法**：
1. 開啟 Apps Script 編輯器
2. 點選「執行記錄」
3. 查看是否有錯誤訊息
4. 檢查是否有「告警已抑制」訊息

### 問題 2：測點名稱不匹配

**症狀**：提交資料後，沒有驗證或告警

**原因**：TempHumidity_Criteria 中的測點名稱與實際名稱不一致

**檢查方法**：
1. 開啟 Temperature_Humidity 工作表
2. 查看「測點名稱」欄位的實際名稱
3. 與 TempHumidity_Criteria 比對

**正確格式**：
- ✅ `秤料室濕度` (不含括號和單位)
- ❌ `秤料室濕度 (%RH)` (含括號和單位)

### 問題 3：郵件被擋在垃圾郵件

**解決方法**：
1. 將系統郵件地址加入白名單
2. 系統預設使用與試算表相同的 Google 帳號發送
3. 在 Gmail 中設定篩選器：
   ```
   寄件者：your-google-account@gmail.com
   主旨包含：溫濕度異常告警
   → 永不傳送到垃圾郵件
   → 套用星號
   ```

### 問題 4：告警發送失敗

**可能原因**：
- Google 帳號權限不足
- 超過 Gmail 每日發送上限（100 封/天）
- 收件人 Email 無效

**查看方法**：
1. Apps Script 執行記錄
2. 查找「發送郵件失敗」訊息

---

## 📊 查看告警歷史

系統會自動記錄所有發送的告警：

### 開啟方式
1. 在試算表中找到「**Alert_History**」工作表
2. 如果沒有，表示還沒有發送過告警

### 欄位說明
| 欄位 | 說明 |
|------|------|
| 告警時間 | 發送時間 |
| 測點名稱 | 哪個測點 |
| 區域 | 所屬區域 |
| 數值 | 測量值 |
| 單位 | ℃ 或 %RH |
| 告警等級 | 警告/嚴重 |
| 偏離值 | 超標多少 |
| 收件人 | Email清單 |
| 點檢人員 | 誰點檢的 |
| 備註 | 點檢備註 |

---

## 💡 最佳實踐建議

### 1. 收件人設定
- 至少 2 位收件人（避免單點失效）
- 包含：品管人員 + 主管
- 定期檢查 Email 是否有效

### 2. 標準值設定
- 根據 HACCP 規範設定
- 留有合理緩衝空間
- 定期審查調整

### 3. 告警響應
- 收到告警立即處理
- 記錄處理措施
- 持續監控後續狀況

### 4. 定期測試
- 每月測試一次告警功能
- 確認郵件能正常收到
- 檢查 Alert_History 記錄

### 5. 文檔維護
- 更新收件人清單
- 記錄標準值變更
- 保存告警處理記錄

---

## 📞 技術支援

如有任何問題，請：
1. 查看 Apps Script 執行記錄
2. 檢查系統日誌
3. 參考本文檔故障排除章節
4. 聯繫系統管理員

---

**文件版本**：v1.0  
**更新日期**：2026-01-26  
**適用系統版本**：v2.2.3+
